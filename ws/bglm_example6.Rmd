---
title: "GLM Part6"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(rstanarm)   #for fitting models in STAN
library(brms)       #for fitting models in STAN
library(coda)       #for diagnostics
library(bayesplot)  #for diagnostics
library(rstan)      #for interfacing with STAN
library(DHARMa)     #for residual diagnostics
library(emmeans)    #for marginal means etc
library(broom)      #for tidying outputs
library(tidybayes)  #for more tidying outputs
library(ggeffects)  #for partial plots
library(tidyverse)  #for data wrangling etc
```

# Scenario

An ecologist studying a rocky shore at Phillip Island, in southeastern Australia, was interested in how
clumps of intertidal mussels are maintained [@Quinn-1988-137]. In particular, he wanted to know how densities of adult
mussels affected recruitment of young individuals from the plankton. As with most marine invertebrates,
recruitment is highly patchy in time, so he expected to find seasonal variation, and the interaction
between season and density - whether effects of adult mussel density vary across seasons - was the aspect
of most interest.

The data were collected from four seasons, and with two densities of adult mussels. The experiment
consisted of clumps of adult mussels attached to the rocks. These clumps were then brought back to the
laboratory, and the number of baby mussels recorded. There were 3-6 replicate clumps for each density
and season combination.

Format of quinn.csv data files

SEASON   DENSITY   RECRUITS   SQRTRECRUITS   GROUP
-------- --------- ---------- -------------- ------------
Spring   Low       15         3.87           SpringLow
..       ..        ..         ..             ..
Spring   High      11         3.32           SpringHigh
..       ..        ..         ..             ..
Summer   Low       21         4.58           SummerLow
..       ..        ..         ..             ..
Summer   High      34         5.83           SummerHigh
..       ..        ..         ..             ..
Autumn   Low       14         3.74           AutumnLow
..       ..        ..         ..             ..

------------------ --------------------------------------------------------------------------------------------
**SEASON**         Categorical listing of Season in which mussel clumps were collected ­ independent variable
**DENSITY**        Categorical listing of the density of mussels within mussel clump ­ independent variable
**RECRUITS**       The number of mussel recruits ­ response variable
**SQRTRECRUITS**   Square root transformation of RECRUITS - needed to meet the test assumptions
**GROUPS**         Categorical listing of Season/Density combinations - used for checking ANOVA assumptions
------------------ --------------------------------------------------------------------------------------------

![Mussel](../resources/mussels.jpg){height="300"}

# Read in the data

```{r readData, results='markdown', eval=TRUE}
quinn = read_csv('../data/quinn.csv', trim_ws=TRUE)
glimpse(quinn)
summary(quinn)
```

```{r dataprep, results='markdown', eval=TRUE}
quinn = quinn %>%
  mutate(SEASON = factor(SEASON,
                         levels=c('Spring', 'Summer', 'Autumn', 'Winter')),
                         DENSITY = factor(DENSITY))
```

	
# Exploratory data analysis

Counts so Poisson.

Model formula:
$$
\begin{align}
y_i &\sim{} \mathcal{NB}(\lambda_i, \theta)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0,10)\\
\beta_{1,2,3} &\sim{} \mathcal{N}(0,2.5)\\
\theta &\sim{} \mathcal{Exp}(1)
\end{align}
$$

where $\boldsymbol{\beta}$ is a vector of effects parameters and $\bf{X}$ is a model matrix representing the intercept and effects of season, density and their interaction on mussel recruitment.

${\beta_0}$ is the first category and seven more ${\beta}$.

# Priors

Weakly informative prior is harder to set than informative priors from literature, previous knowledge, etc.

```{r explore}
quinn %>% group_by(SEASON, DENSITY) %>% summarize(log(median(RECRUITS)), log(mad(RECRUITS))) # robust deviance
```

$$
\beta_0 \sim{} \mathcal{N}(3,2)\\
\beta_x \sim{} \mathcal{N}(0,1)\\
$$

```{r priors}
priors <-  prior(normal(2,3), class = 'Intercept') +
  prior(normal(0, 1), class = 'b')
```


# Fit the model {.tabset .tabset-faded}

Define formula up front like the priors.

```{r model formula up front}
quinn.form <- bf(RECRUITS ~ SEASON * DENSITY,
                 family = poisson(link = 'log'))
```

## Prior only model

```{r prior only model}
quinn.brm2 <- brm(quinn.form, 
                 data = quinn,
                 prior = priors,
                 sample_prior = 'only',
                 chains = 3,
                 iter = 5000,
                 warmup = 2500,
                 thin = 5)
```

We are interested in the interactions here so specifically asking for that plot. If left out would get all plots.

```{r plot}
quinn.brm2 %>% conditional_effects('SEASON:DENSITY') %>% plot(points = TRUE)
```

## Prior and data model

```{r update model}
quinn.brmP <- quinn.brm2 %>% update(sample_prior = 'yes')
```

Looks good.

```{r check priors}
quinn.brmP %>% hypothesis('SEASONSummer<0') %>% plot()
```

Should check all...

```{r check priors}
quinn.brmP %>% hypothesis('SEASONWinter<0') %>% plot()
```

### Posterior checks

```{r posterior checks}
quinn.brmP %>% pp_check(type = 'dens_overlay', ndraws = 250)
```

# MCMC validation {.typset}

## Trace plots

```{r trace}
quinn.brmP$fit %>% stan_trace()
```

## Autocorrelation

```{r autocorr}
quinn.brmP$fit %>% stan_ac()
```

## Efficiency

```{r ess}
quinn.brmP$fit %>% stan_ess()
```

## Rhat

```{r rhat}
quinn.brmP$fit %>% stan_rhat()
```

# Model validation

## DHARMa residuals

Does not look good.

```{r DHARMa}
preds <- quinn.brmP %>% posterior_predict(ndraws = 250, summary = FALSE) #ndraws instead of nsample

quinn.resids <- createDHARMa(simulatedResponse = t(preds), # transpose matrix
                            observedResponse = quinn$RECRUITS, # only thing that will change
                            fittedPredictedResponse = apply(preds, 2, median), # calc median for each column
                            integerResponse = FALSE)
quinn.resids %>% plot()
```

Way over dispersed because red line is way off to the right.

Causes of over dispersion:

1. 0-inflated -> 0-inflated or Hurdle model
    - not too many, but one category had a lot
2. More variance than model expects (Poisson in this case). Could fit an observation level random effect.

```{r test disperson}
quinn.resids %>% testDispersion()
```

2 out of 3 0s. 

```{r test 0 inflation}
quinn.resids %>% testZeroInflation()
```
 
## Negative binomial model

Good for low level 0-inflation and overdispersion.

## NB priors

lambda - mean
phi - dispersion
$$
y_i \sim \mathcal{N}\beta(\lambda, \phi)\\
\phi \sim{} \Gamma(0.01,0.01)\\
$$

Can have a look at default priors without having to run the model by specifying formula.

Default priors for fixed effects are the flat priors we don't want to use. What are the expectations
Intercept priors similar to as defined above.

```{r new model forumla}
quinn.form <- bf(RECRUITS ~ SEASON * DENSITY, family = negbinomial(link = 'log'))

get_prior(quinn.form, data = quinn) # get default priors
```

```{r add gamma to priors}
priors <-  priors + prior(gamma(0.1, 0.1), class = 'shape')
```

## Fit NB model

Default is to sample from both priors and data. Already knew previous priors were good and gamma prior for NB is standard. Do not have to test priors only model again.

```{r fit NB model}
quinn.brmNB <- brm(quinn.form,
                   data = quinn,
                   chains = 3,
                   iter = 5000,
                   warmup = 2500,
                   thin = 5)
```

## DHARMa residuals

```{r DHARMa NB}
preds <- quinn.brmNB %>% posterior_predict(ndraws = 250, summary = FALSE) #ndraws instead of nsample

quinn.resids <- createDHARMa(simulatedResponse = t(preds), # transpose matrix
                            observedResponse = quinn$RECRUITS, # only thing that will change
                            fittedPredictedResponse = apply(preds, 2, median), # calc median for each column
                            integerResponse = FALSE)
quinn.resids %>% plot()
```

```{r plot}
quinn.brmNB %>% conditional_effects('SEASON:DENSITY') %>% 
  plot(points = TRUE, jitter = c(0.5, 0))
```

# Model investigation / hypothesis testing

Can get the summary numbers plus more:

```{r gather draws}
quinn.brmNB %>% get_variables()

quinn.draw <-  quinn.brmNB %>% gather_draws(`^b_.*`, regex = TRUE)
quinn.draw # numbers on log link scale
```

Any evidence of interactions? fold scale does credible interval cross 1.

b_SEASONSummer:DENSITYLow - strong evidence of significant interaction
b_SEASONWinter:DENSITYLow - no evidence of significant interaction, lower/upper crosses 1

```{r table}
quinn.draw %>% median_hdci() # on log scale
quinn.draw %>% mutate(Exp = exp(.value)) %>% median_hdci(Exp) # back transform to fold scale
quinn.draw
```

## Exceedence p-values

Quick glance on credibility intervals above.

b_SEASONWinter:DENSITYLow above was not 'significant' but here there is some evidence it is a significant interaction.

```{r e pvalues}
quinn.draw %>% mutate(Exp = exp(.value)) %>% summarize(P1 = sum(Exp > 1)/n(),
                                                       P2 = sum(Exp < 1)/n())
```

## Pairwise tests

Evidence of significant interaction - what next?

### Fold scale

Pairwise comparison of seasons separately for each density, or density effects in each season.

Winter is the interesting season - 2x difference between High and Low

```{r density in season effect}
quinn.brmNB %>% 
  emmeans(~DENSITY|SEASON, type = 'response') %>% # fold scale
  pairs()
```

`pairs()` does difference between contrasts before backtransforming so it is on a fold scale.

```{r gather interaction draws}
quinn.brmNB %>% 
  emmeans(~DENSITY|SEASON, type = 'link') %>% # fold scale
  pairs() %>% 
  gather_emmeans_draws() %>% 
  mutate(Exp = exp(.value)) -> quinn.em
quinn.em
```

Difference between High-Low in spring - no evidence
Difference between High-Low in Summer - strong evidence
Difference between High-Low in Autumn - no evidence
Difference between High-Low in Winter - strong evidence, depsite absolute difference is small. Could express on absolute scale saying represents change of 4 barnacles vs in summer represents change of 20.

```{r p-value calc}
quinn.em %>% summarize(P = sum(Exp > 1)/n(), P2 = sum(Exp < 1)/n()) # fold scale ref to 1
```

### Absolute scale

Absolute change in number of recruits between High-Low in Spring is -1 individuals.

Winter was a doubling but only represents 3 more barnacles as shown here on average of lots of samples.

```{r gather interaction draws abs scale}
quinn.brmNB %>% 
  emmeans(~DENSITY|SEASON, type = 'link') %>% # fold scale
  regrid %>% # backtransform before doing difference before pairs
  pairs() %>% 
  gather_emmeans_draws() -> quinn.em
quinn.em %>% median_hdci()
```

Could still compare to 0 but would be different scale for each interaction. Change in 10 in Winter v Summer is different.

Below is the same as previous p-value calc table.

```{r compare against 0}
quinn.em %>% summarize(P = sum(.value>0)/n())
```

# R2

Explaining around 72% of the variance.

```{r r2}
quinn.brmNB %>% bayes_R2(summary = FALSE) %>% median_hdci()
```

# Results summary

- Statement about significant interactions.
- There was strong evidence (**Exceed.** P = 0.9XX) to suggest that the number of recruits was higher in high density treatment populations than low density populations in Winter.
- Whilst the absolute difference in the number of recruits was 2.9 individuals (CI: -1 to 6), this represented a two-fold (CI: 0.95 - 4.1) increase (see Figure 1). 
    - good to give CI for all because can't calculate one from the other
# Rstan code

```{r fitModel, results='markdown', eval=FALSE, hidden=TRUE}
head(quinn)
ggplot(quinn, aes(y=RECRUITS, x=SEASON, fill=DENSITY)) + geom_boxplot()
library(rstanarm)
##Poisson
quinn.rstanarmP <- stan_glm(RECRUITS~SEASON*DENSITY, data=quinn,
                         family=poisson(link='log'),refresh=0,
                         chains = 3, iter = 5000, thin=5, warmup=2000)
prior_summary(quinn.rstanarmP)


prior_summary(quinn.rstanarmP)

quinn.rstanarm1 <- stan_glm(RECRUITS~SEASON*DENSITY, data=quinn,
                            family=poisson(link='log'),
                            prior_intercept = normal(2.3, 5, autoscale=FALSE),
                            prior=normal(0, 2, autoscale=FALSE),
                            prior_PD=TRUE, 
                            refresh=0,
                         chains = 3, iter = 5000, thin=5, warmup=2000)

ggpredict(quinn.rstanarm1,  ~SEASON+DENSITY) %>% plot()
ggemmeans(quinn.rstanarmP,  ~SEASON+DENSITY) %>%
  plot(add.data=TRUE)

quinn.rstanarm3= update(quinn.rstanarm1,  prior_PD=FALSE) 
posterior_vs_prior(quinn.rstanarm3, color_by='vs', group_by=TRUE,
                   facet_args=list(scales='free_y'))

ggpredict(quinn.rstanarm3,  ~SEASON+DENSITY) %>% plot(add.data=TRUE)
ggemmeans(quinn.rstanarm3,  ~SEASON+DENSITY) %>% plot(add.data=TRUE)



plot(quinn.rstanarm3,  plotfun='mcmc_trace')
plot(quinn.rstanarm3,  'mcmc_acf_bar')
plot(quinn.rstanarm3,  'mcmc_rhat_hist')
plot(quinn.rstanarm3,  'mcmc_neff_hist')


preds <- posterior_predict(quinn.rstanarm3,  nsamples=250,  summary=FALSE)
quinn.resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = quinn$RECRUITS,
                            fittedPredictedResponse = apply(preds, 2, median), 
                            integerResponse=TRUE)
plot(quinn.resids)
testZeroInflation(quinn.resids)


#pp_check(day.rstanarm, x=as.numeric(day$TREAT),'intervals')
quinn.rstanarmNB <- stan_glm(RECRUITS~SEASON*DENSITY, data=quinn,
                        family=neg_binomial_2(link='log'), refresh=0,
                        chains = 3,iter = 5000, thin=5,warmup=2000)
prior_summary(quinn.rstanarmNB)
ggpredict(quinn.rstanarmNB,  ~SEASON*DENSITY) %>% plot(add.data=TRUE)

set.seed(123)
quinn.rstanarmNB <- stan_glm(RECRUITS~SEASON*DENSITY, data=quinn,
                        family=neg_binomial_2(link='log'), refresh=0,
                        prior_intercept = normal(2.3, 5, autoscale=FALSE),
                        prior=normal(0, 1, autoscale=FALSE),
                        prior_aux=rstanarm::exponential(1, autoscale=FALSE), 
                        prior_PD=TRUE, 
                        chains = 3,iter = 5000, thin=5,warmup=2000)

quinn.rstanarmNB <- stan_glm(RECRUITS~SEASON*DENSITY, data=quinn,
                        family=neg_binomial_2(link='log'), refresh=0,
                        prior_intercept = normal(2.3, 2.5, autoscale=FALSE),
                        prior=normal(0, 1, autoscale=FALSE),
                        prior_aux=rstanarm::exponential(1, autoscale=FALSE), 
                        prior_PD=TRUE, 
                        chains = 3,iter = 5000, thin=5,warmup=2000)
ggpredict(quinn.rstanarmNB,  ~SEASON+DENSITY) %>% plot(add.data=TRUE)
p = ggpredict(quinn.rstanarmNB) %>% plot(add.data=TRUE)
p[[1]] + p[[2]]

ggemmeans(quinn.rstanarmNB,  ~SEASON+DENSITY) %>%
  plot(add.data=TRUE)

quinn.rstanarmNB= update(quinn.rstanarmNB,  prior_PD=FALSE) 
posterior_vs_prior(quinn.rstanarmNB, color_by='vs', group_by=TRUE,
                   facet_args=list(scales='free_y'))

p = ggpredict(quinn.rstanarmNB) %>% plot(add.data=TRUE)
p[[1]] + p[[2]]

ggemmeans(quinn.rstanarmNB,  ~SEASON+DENSITY) %>% plot(add.data=TRUE)

plot(quinn.rstanarmNB,  'mcmc_trace')
plot(quinn.rstanarmNB,  'mcmc_acf_bar')
plot(quinn.rstanarmNB,  'mcmc_rhat_hist')
plot(quinn.rstanarmNB,  'mcmc_neff_hist')


preds <- posterior_predict(quinn.rstanarmNB,  nsamples=250,  summary=FALSE)
quinn.resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = quinn$RECRUITS,
                            fittedPredictedResponse = apply(preds, 2, median),
                            integerResponse=TRUE)
plot(quinn.resids)

prior_summary(quinn.rstanarmNB)
(loo.P = loo(quinn.rstanarmP))
(loo.NB = loo(quinn.rstanarmNB))
loo_compare(loo.P, loo.NB)

posterior_vs_prior(quinn.rstanarmNB, color_by='vs', group_by=TRUE,
                   facet_args=list(scales='free_y'))


ggplot() + geom_point(data=NULL, aes(y=quinn.resids$scaledResiduals, x=quinn$SEASON))
ggplot() + geom_point(data=NULL, aes(y=quinn.resids$scaledResiduals, x=quinn$DENSITY))

## stan_trace(quinn.rstanarm)
## stan_dens(quinn.rstanarm,separate_chains=TRUE)
## stan_ac(quinn.rstanarm)
## stan_rhat(quinn.rstanarm)
## stan_ess(quinn.rstanarm)

## pp_check(quinn.rstanarm)
## available_ppc()
## pp_check(quinn.rstanarm, x=quinn$SEASON,'boxplot')
## pp_check(quinn.rstanarm, group=interaction(quinn$DENSITY,quinn$SEASON),
##          'stat_grouped')
## pp_check(quinn.rstanarm, x=as.numeric(quinn$SEASON),group=quinn$DENSITY,
##          plotfun='intervals_grouped')
## #pp_check(quinn.rstanarm, x=as.numeric(quinn$SEASON), plotfun='error_scatter_avg_vs_x')


ggemmeans(quinn.rstanarmNB,  ~SEASON*DENSITY) %>% plot
ggpredict(quinn.rstanarmNB,  ~SEASON*DENSITY) %>% plot
library(patchwork)
g[[1]] + g[[2]]
do.call('+', g)

summary(quinn.rstanarmNB)
tidyMCMC(quinn.rstanarmNB$stanfit,
         estimate.method='median', 
         conf.int=TRUE, conf.method='HPDinterval',
         rhat=TRUE, ess=TRUE) %>% knitr::kable()
## express this on response scale
quinn.rstanarmNB %>% get_variables()
quinn.rstanarmNB %>%
  gather_draws(`.Intercept.*|SEASON.*|DENSITY.*`, regex=TRUE) %>%
  group_by(.variable) %>%
  mutate(.value=exp(.value)) %>%
  median_hdci

newdata = emmeans(quinn.rstanarmNB, ~SEASON|DENSITY, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=prob, x=SEASON, fill=DENSITY)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD), shape=21,
                    position=position_dodge(width=0.5)) +
    #geom_line(aes(x=as.numeric(SEASON))) +
    theme_bw()


bayes_R2(quinn.rstanarmNB) %>% median_hdi

## Compare effect of density separate within each season
emmeans(quinn.rstanarmNB, pairwise~DENSITY|SEASON, type='response') 
emmeans(quinn.rstanarmNB, pairwise~DENSITY|SEASON, type='response')$contrast 
quinn.em = emmeans(quinn.rstanarmNB, pairwise~DENSITY|SEASON, type='link')$contrast %>%
  gather_emmeans_draws() %>% 
  mutate(Fit=exp(.value))
head(quinn.em)

g2 = quinn.em %>%
  group_by(contrast, SEASON) %>%
  median_hdci %>%
    ggplot() + geom_pointrange(aes(y=Fit, x=SEASON, ymin=Fit.lower, ymax=Fit.upper)) + 
    geom_hline(yintercept=1, linetype='dashed') + coord_flip() +
    scale_y_continuous('Effect size (High/Low)')

ggplot(quinn.em, aes(x=Fit)) +
    geom_histogram() +
    facet_wrap(SEASON~contrast, scales='free')
quinn.em %>% group_by(contrast, SEASON) %>% median_hdci(Fit)
# Probability of effect
quinn.em %>% group_by(contrast,SEASON) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
quinn.em %>% group_by(contrast,SEASON) %>% summarize(P=sum(Fit>1.1)/n())

quinn.em1 <-
  emmeans(quinn.rstanarmNB, ~DENSITY|SEASON, type='link') %>%
  gather_emmeans_draws() %>%
  mutate(Fit = exp(.value))
  


bayes_R2(quinn.rstanarmNB) %>% median_hdci

newdata = emmeans(quinn.rstanarmNB, ~SEASON|DENSITY, type='response') %>% as.data.frame
head(newdata)
g1 = ggplot(newdata, aes(y=prob, x=SEASON, color=DENSITY)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD),
                    position=position_dodge(width=0.2))
library(patchwork)
g1 + g2
grid.arrange(g1, g2, nrow=1)




loo(quinn.rstanarmP)

quinn.rstanarm1 <- stan_glm(RECRUITS~SEASON+DENSITY, data=quinn,
                        family='neg_binomial_2',
                       prior = normal(0, 1),
                       prior_intercept = normal(0,10),
                       prior_aux=cauchy(0,2),
                       chains = 3,iter = 2000, thin=2,warmup=1000)

quinn.rstanarm <- stan_glm(RECRUITS~SEASON*DENSITY, data=quinn,
                        family='neg_binomial_2',
                       prior = normal(0, 10),
                       prior_intercept = normal(0,10),
                       prior_aux=cauchy(0,2),
                       chains = 3,iter = 2000, thin=2,warmup=1000)
quinn.rstanarm1 <- stan_glm(RECRUITS~SEASON+DENSITY, data=quinn,
                        family='neg_binomial_2',
                       prior = normal(0, 10),
                       prior_intercept = normal(0,10),
                       prior_aux=cauchy(0,2),
                       chains = 3,iter = 2000, thin=2,warmup=1000)

l1 = loo(quinn.rstanarm)
l2 = loo(quinn.rstanarm1)
compare_models(l1,l2)

newdata <- with(quinn,expand.grid(SEASON=levels(SEASON),
                                  DENSITY=levels(DENSITY)))
Xmat<- model.matrix(~SEASON*DENSITY, data=newdata)
as.matrix(quinn.rstanarm) %>% head
coefs = as.matrix(quin.rstanarm)
coefs = as.matrix(as.data.frame(quinn.rstanarm) %>%
                  dplyr:::select(-reciprocal_dispersion)) %>%
    as.matrix
coefs = as.data.frame(quinn.rstanarm) %>%
    dplyr:::select(-reciprocal_dispersion) %>%
    as.matrix
fit = exp(coefs %*% t(Xmat))
newdata = newdata %>%
    cbind(tidyMCMC(fit, conf.int=TRUE, conf.method='HPDinterval'))
head(newdata)

ggplot(newdata, aes(y=estimate, x=SEASON, fill=DENSITY)) +
geom_blank() +
geom_line(aes(x=as.numeric(SEASON), ymin=conf.low, ymax=conf.high, linetype=DENSITY))+
geom_pointrange(aes(ymin=conf.low, ymax=conf.high), shape=21) 

#Compare high and low in each season
#via contrasts
newdata <- with(quinn,expand.grid(SEASON=levels(SEASON),DENSITY=levels(DENSITY)))
## factor differences
Xmat<- model.matrix(~SEASON*DENSITY, data=newdata)
Xmat.high <- Xmat[newdata$DENSITY=="High",]
Xmat.low <- Xmat[newdata$DENSITY=="Low",]
Xmat.density <- Xmat.high-Xmat.low
rownames(Xmat.density) <- levels(quinn$SEASON)
coefs = as.matrix(as.data.frame(quinn.rstanarm) %>% dplyr:::select(-reciprocal_dispersion))
fit = exp(coefs %*% t(Xmat.density))
tidyMCMC(fit, conf.int=TRUE, conf.method='HPDinterval')
## or absolute
fit.high = coefs %*% t(Xmat.high)
fit.low = coefs %*% t(Xmat.low)
fit = exp(fit.high) - exp(fit.low)
#fit = exp(fit.high - fit.low)
tidyMCMC(fit, conf.int=TRUE, conf.method='HPDinterval')
```

```{r fitModel.brms, results='markdown', eval=FALSE, hidden=TRUE}
head(quinn)
ggplot(quinn, aes(y=RECRUITS, x=SEASON, fill=DENSITY)) + geom_boxplot()
library(rstanarm)
##Poisson
quinn.form <- bf(RECRUITS ~ SEASON*DENSITY,  family=poisson(link='log'))
get_prior(quinn.form,  data=quinn)

quinn.brmsP <- brm(quinn.form, data=quinn,
                         refresh=0,
                         chains = 3, iter = 5000, thin=5, warmup=2000)

mcmc_plot(quinn.brmsP,  type='trace')
mcmc_plot(quinn.brmsP,  type='acf_bar')
mcmc_plot(quinn.brmsP,  type='rhat_hist')
mcmc_plot(quinn.brmsP,  type='neff_hist')


preds <- posterior_predict(quinn.brmsP,  nsamples=250,  summary=FALSE)
quinn.resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = quinn$RECRUITS,
                            fittedPredictedResponse = apply(preds, 2, median),
                            integerResponse = TRUE)
plot(quinn.resids)


quinn.form <- bf(RECRUITS ~ SEASON*DENSITY,  family=negbinomial(link='log'))
get_prior(quinn.form,  data=quinn)

quinn.brmsNB <- brm(quinn.form, data=quinn,
                         refresh=0,
                         chains = 3, iter = 5000, thin=5, warmup=2000)

mcmc_plot(quinn.brmsNB,  type='trace')
mcmc_plot(quinn.brmsNB,  type='acf_bar')
mcmc_plot(quinn.brmsNB,  type='rhat_hist')
mcmc_plot(quinn.brmsNB,  type='neff_hist')


preds <- posterior_predict(quinn.brmsNB,  nsamples=250,  summary=FALSE)
quinn.resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = quinn$RECRUITS,
                            fittedPredictedResponse = apply(preds, 2, median),
                            integerResponse=TRUE)
plot(quinn.resids)
#pp_check(day.rstanarm, x=as.numeric(day$TREAT),'intervals')

(loo.P = loo(quinn.brmsP))
(loo.NB = loo(quinn.brmsNB))
loo_compare(loo.P, loo.NB)

ggplot() +
  geom_point(data=NULL, aes(y=quinn.resids$scaledResiduals, x=quinn$SEASON))
ggplot() +
  geom_point(data=NULL, aes(y=quinn.resids$scaledResiduals, x=quinn$DENSITY))


#g=ggpredict(quinn.brmsNB) %>% plot
ggemmeans(quinn.brmsNB, terms=~SEASON*DENSITY) %>% plot
#g[[1]] + g[[2]]
#do.call('grid.arrange', g)

summary(quinn.brmsNB)
tidyMCMC(quinn.brmsNB$fit,
         estimate.method='median', 
         conf.int=TRUE, conf.method='HPDinterval',
         rhat=TRUE, ess=TRUE)
emmeans(quinn.brmsNB, pairwise~SEASON, type='link')
newdata =  emmeans(quinn.brmsNB, ~SEASON|DENSITY, type='response') %>%
    as.data.frame
head(newdata)
ggplot(newdata, aes(y=prob, x=SEASON, fill=DENSITY)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD), shape=21,
                    position=position_dodge(width=0.5)) +
    #geom_line(aes(x=as.numeric(SEASON))) +
    theme_bw()


bayes_R2(quinn.brmsNB, summary=FALSE) %>% median_hdi

## Compare effect of density separate within each season
emmeans(quinn.brmsNB, pairwise~DENSITY|SEASON, type='response') 
quinn.em = emmeans(quinn.brmsNB, pairwise~DENSITY|SEASON, type='link')$contrast %>%
  gather_emmeans_draws() %>% 
  mutate(Fit=exp(.value))
head(quinn.em)

g2 = quinn.em %>%
  group_by(contrast, SEASON) %>%
  median_hdi %>%
  ggplot() +
  geom_pointrange(aes(y=Fit, x=SEASON, ymin=Fit.lower, ymax=Fit.upper)) + 
  geom_hline(yintercept=1, linetype='dashed') + coord_flip() +
  scale_y_continuous('Effect size (High/Low)')
g2

ggplot(quinn.em, aes(x=Fit)) +
    geom_histogram() +
  facet_wrap(SEASON~contrast, scales='free')
quinn.em %>% group_by(contrast, SEASON) %>% mean_hdci()
# Probability of effect
quinn.em %>% group_by(contrast,SEASON) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
quinn.em %>% group_by(contrast,SEASON) %>% summarize(P=sum(Fit>1.1)/n())



bayes_R2(quinn.brmsNB, summary=FALSE) %>% median_hdi

newdata = emmeans(quinn.brmsNB, ~SEASON|DENSITY, type='response') %>% as.data.frame
head(newdata)
g1 = ggplot(newdata, aes(y=prob, x=SEASON, color=DENSITY)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD),
                    position=position_dodge(width=0.2))
library(patchwork)
g1 + g2
#grid.arrange(g1, g2, nrow=1)



quinn = quinn %>%
  group_by(SEASON, DENSITY) %>%
  mutate(Obs=factor(1:n()))

quinn.form <- bf(RECRUITS ~ SEASON*DENSITY + (1|Obs),  family=poisson(link='log'))
get_prior(quinn.form,  data=quinn)

quinn.brmsU <- brm(quinn.form, data=quinn,
                         refresh=0,
                         chains = 3, iter = 5000, thin=5, warmup=2000)

preds <- posterior_predict(quinn.brmsU,  nsamples=250,  summary=FALSE)
quinn.resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = quinn$RECRUITS,
                            fittedPredictedResponse = apply(preds, 2, median))
plot(quinn.resids)
newdata = emmeans(quinn.brmsU, ~SEASON|DENSITY, type='response') %>% as.data.frame
newdata
ggplot(newdata, aes(y=rate, x=SEASON, color=DENSITY)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD),
                    position=position_dodge(width=0.2))

```


# References
