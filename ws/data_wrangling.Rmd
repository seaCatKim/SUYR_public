---
title: "Data wrangling"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
 
# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(tidyverse) #for data wrangling
```

Link to the data transformation cheatsheet 

https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf

Important data manipulation functions:

+--------------------------+-----------------------------------+------------+
|Task                      |Function                           |Package     |
+==========================+===================================+============+
|Sorting                   |`arrange()`                        |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Adding columns            |`mutate()`                         |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Transformations           |`mutate()`                         |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Re-ordering factor levels |`factor(,levels=)`                 |base        |
+--------------------------+-----------------------------------+------------+
|Re-labelling              |`factor(,lab=)`                    |base        |
+--------------------------+-----------------------------------+------------+
|                          |`recode()`                         |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Re-naming columns         |`rename(,replace=)`                |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Filtering/Subsetting      |indexing                           |base        |
+--------------------------+-----------------------------------+------------+
|~ columns                 |`select(,...)`                     |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|                          |`pull(,...)`                       |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|~ rows                    |`filter(,...)`                     |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Unique combinations       |`distinct()`                       |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Reshaping data            | `pivot_longer()`, `pivot_wider()` | **tidyr**  |
+--------------------------+-----------------------------------+------------+
|Split/combine columns     | `separate()`, `unite()`           | **tidyr**  |
+--------------------------+-----------------------------------+------------+
|Aggregating               |`group_by()` `summarise()`         |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|                          |`group_by()` `count()`             |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Merging/joining           |`*_join()`                         |**dplyr**   |
+--------------------------+-----------------------------------+------------+
|Extracting data structure |`expand()`                         |**tidyr**   |
+--------------------------+-----------------------------------+------------+
|                          |`crossing()`                       |**tidyr**   |
+--------------------------+-----------------------------------+------------+


# Data files

load() loads objects in R format. Can save things as R formats using save(). Just list multiple object names to save in the same .RData file. 

Fake dataset for manipulating.
Plots with 3 treatments with different time points and responses.

```{r getData, results='markdown', eval=TRUE}
load(file='../data/manipulationDatasets.RData')
dat.1 %>% head
```

str() used on any object. Tells you what the data are considered as. Is it what you expect? Could have a numeric column that is character because of a stray letter.

```{r checking data}
str(dat.1)

dat.1 %>% str()
```

Dense summary:

```{r glimpse}
glimpse(dat.1)
```

# Tidyverse

Collection of packages designed to work together.

Has a grammar.

## Dataframes and tibbles

Most things should work with both but not always...

```{r print as tibble}
dat.1 %>% as_tibble()
# SAME AS
dat.1 %>% as_tibble() %>% print
```

**Tibbles:**
* Print to fit on the consol 'page.'
* Rounds numbers for display, actual data has not been changed.
* Can put anything you like in a cell (instructions for a plot, a tibble) vs 1 number/factor in a dataframe.
  * For tibble with 2 factors - can put instructions for a graph in a cell. Pack a lot of information and don't need to use loops.
  * R is an interpretive (vs compiled) language where looping is slow.

# Piping

Write little programs that do one function - filter, sort, etc. - and then string them together using pipes.

Can use this for any function where a dataframe is the first argument.

```{r, results='markup'}
head(dat.1)
#OR
dat.1 %>% head()
#OR
dat.1 %>% head # with no args can leave off brackets - lintr will probably yell though
```

```{r storing piped outputs}
dat.1.trunc <- dat.1 %>% head()
# OR
dat.1 %>% head() -> dat.1.trunc
# more accessible in that it follows the logical order
```

Sorting data using arrange()
================

Does not reorder levels of a factor.

```{r sort by Resp1}
dat.1 %>% arrange(Resp1) # ascending order

# descending order
dat.1 %>% arrange(-Resp1) %>% head
dat.1 %>% arrange(desc(Resp1)) %>% 
  head %>% knitr::kable() # will come out as a nice neat table in html, no scroll bar so just used head
```

Sort by multiple columns:

```{r sort more columns}
dat.1 %>%  arrange(Dose, Resp1)
```

Sort by the sum of Resp1 and Resp2. Don't need to be existing columns - can create a new column from existing to sort by.

```{r sort by operation}
dat.1 %>% arrange(Resp1 + Resp2)
```

Sort by treatment then time.

```{r sort treatment, time}
head(dat.1)
dat.1 %>% arrange(Treatment, Time)
```

```{r Treatment then mean of Resp1, Resp2}
dat.1 %>% arrange(Treatment, mean(c(Resp1, Resp2))) # note vector to mean Resp1 and Resp2 columns
```

Adding columns - mutate()
===========================

mutate() is working row by row. 

```{r mutate Sum column}
dat.1 %>% mutate(Sum = Resp1 + Resp2)
```


Summarising (aggregating) data
=================================


Grouping (=aggregating)
=========================


Subset columns
=================

## Regular expressions (regex)

https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf

Filtering
=============

Reshaping data
=================

## Pivot longer

## Pivot wider

Combining data
=================

Applied examples
===================
